{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="content-container">
        <div class="page-header">
            <h1><i class="fas fa-chart-bar"></i> 基本圖表分析</h1>
            <p>使用長條圖、圓餅圖、折線圖深入分析攻擊資料</p>
        </div>

        <!-- Bar Chart: Industry Analysis -->
        <div class="chart-container">
            <h3 class="chart-title">
                <i class="fas fa-chart-bar"></i> 產業類型攻擊分析
            </h3>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>圖表說明：</strong>橫向長條圖顯示各產業類型的網路攻擊情況，
                可切換檢視攻擊次數或財務損失，幫助分析不同產業面臨的威脅程度。
            </div>

            <!-- Toggle buttons -->
            <div class="mb-3 text-center">
                <div class="btn-group" role="group" aria-label="Chart type toggle">
                    <button type="button" class="btn btn-primary active" id="attack-count-btn"
                        onclick="switchIndustryChart('count')">
                        <i class="fas fa-hashtag"></i> 攻擊次數
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="financial-loss-btn"
                        onclick="switchIndustryChart('loss')">
                        <i class="fas fa-dollar-sign"></i> 財務損失
                    </button>
                </div>
            </div>

            <div id="industry-chart" class="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <div class="mt-3">
                <h6><i class="fas fa-lightbulb"></i> 觀察重點：</h6>
                <div id="industry-insights">
                    <ul id="count-insights">
                        <li><strong>高風險產業：</strong>金融、IT部門通常是攻擊者的主要目標</li>
                        <li><strong>攻擊分散度：</strong>分析攻擊是否集中在特定產業或均勻分布</li>
                        <li><strong>防禦優先級：</strong>攻擊次數高的產業應優先加強網路安全防護</li>
                        <li><strong>產業特性：</strong>不同產業面臨的攻擊類型和頻率可能存在差異</li>
                    </ul>
                    <ul id="loss-insights" style="display: none;">
                        <li><strong>經濟衝擊：</strong>財務損失反映攻擊對產業的實際經濟影響</li>
                        <li><strong>損失集中度：</strong>少數高價值目標可能造成巨大財務損失</li>
                        <li><strong>風險評估：</strong>結合攻擊頻率與財務損失評估產業風險</li>
                        <li><strong>資源配置：</strong>高財損產業需投入更多資源進行防護</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Pie Chart: Attack Types -->
        <div class="chart-container">
            <h3 class="chart-title">
                <i class="fas fa-chart-pie"></i> 不同攻擊類型佔比分析
            </h3>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>圖表說明：</strong>圓餅圖展示各種攻擊類型（DDoS、Port Scan、SQL Injection 等）的相對比例，
                幫助理解當前網路威脅的主要形式。
            </div>
            <div id="attack-types-chart" class="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="mt-3">
                <h6><i class="fas fa-lightbulb"></i> 觀察重點：</h6>
                <ul>
                    <li><strong>主流威脅：</strong>佔比最大的攻擊類型反映當前最普遍的網路威脅手法</li>
                    <li><strong>多樣性：</strong>攻擊類型的多樣化程度顯示威脅環境的複雜性</li>
                    <li><strong>DDoS 攻擊：</strong>通常佔比較高，因為發動成本低、影響範圍廣</li>
                    <li><strong>Port Scan：</strong>常作為攻擊前的偵察手段，出現頻率也很高</li>
                    <li><strong>SQL Injection：</strong>針對性較強，佔比可能較低但危害性高</li>
                </ul>
            </div>
        </div>

        <!-- Box Plot: Defense Method vs Resolution Time (替換原本的折線圖位置) -->
        <div class="chart-container">
            <h3 class="chart-title">
                <i class="fas fa-box-open"></i> 防禦方法與事件解決時間比較
            </h3>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>圖表說明：</strong>盒鬚圖展示不同防禦方法對應的事件解決時間分布，
                幫助評估各種防禦策略的效率和一致性。
            </div>
            <div id="defense-resolution-chart" class="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <!-- Statistics Table -->
            <div class="mt-3">
                <h6><i class="fas fa-table"></i> 統計摘要：</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped" id="defense-stats-table">
                        <thead class="table-dark">
                            <tr>
                                <th>防禦方法</th>
                                <th>事件數</th>
                                <th>平均時間</th>
                                <th>中位數</th>
                                <th>標準差</th>
                                <th>最短時間</th>
                                <th>最長時間</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-3">
                <h6><i class="fas fa-lightbulb"></i> 觀察重點：</h6>
                <ul>
                    <li><strong>效率比較：</strong>中位數較低的防禦方法通常更有效率</li>
                    <li><strong>一致性分析：</strong>盒子較小的防禦方法表示解決時間較穩定</li>
                    <li><strong>異常值識別：</strong>圖中的點顯示異常長或短的解決時間</li>
                    <li><strong>方法選擇：</strong>綜合考慮平均時間和變異程度選擇最佳防禦策略</li>
                    <li><strong>資源配置：</strong>高變異的方法可能需要更多資源投入</li>
                </ul>
            </div>
        </div>

        <!-- 新增盒鬚圖的優勢說明卡片 -->
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-box-open" style="color: var(--danger-color);"></i>
                            盒鬚圖的優勢
                        </h5>
                        <ul class="small">
                            <li>顯示數據分布情況</li>
                            <li>識別異常值和離群點</li>
                            <li>比較不同組別的差異</li>
                            <li>評估數據變異程度</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentIndustryChart = 'count';

    // Switch between industry chart types
    function switchIndustryChart(type) {
        currentIndustryChart = type;

        // Update button states
        document.getElementById('attack-count-btn').className =
            type === 'count' ? 'btn btn-primary active' : 'btn btn-outline-primary';
        document.getElementById('financial-loss-btn').className =
            type === 'loss' ? 'btn btn-primary active' : 'btn btn-outline-primary';

        // Update insights
        document.getElementById('count-insights').style.display = type === 'count' ? 'block' : 'none';
        document.getElementById('loss-insights').style.display = type === 'loss' ? 'block' : 'none';

        // Reload chart
        loadIndustryChart();
    }

    // Load Industry Analysis chart using Plotly.js
    async function loadIndustryChart() {
        const chartDiv = document.getElementById('industry-chart');
        try {
            chartDiv.classList.add('loading');
            chartDiv.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';

            const response = await fetch(`/api/industry_analysis?type=${currentIndustryChart}`);
            const data = await response.json();
            chartDiv.classList.remove('loading');
            chartDiv.innerHTML = '';

            // Create horizontal bar chart
            const trace = {
                type: 'bar',
                x: data.values,
                y: data.labels,
                orientation: 'h',
                marker: {
                    color: data.values,  // 根據數值大小變色
                    colorscale: currentIndustryChart === 'count' ?
                        [
                            [0, '#E3F2FD'],      // 淺藍
                            [0.5, '#2196F3'],    // 中藍
                            [1, '#0D47A1']       // 深藍
                        ] :
                        [
                            [0, '#FFEBEE'],      // 淺紅
                            [0.5, '#F44336'],    // 中紅
                            [1, '#B71C1C']       // 深紅
                        ],
                    showscale: true,
                    colorbar: {
                        title: currentIndustryChart === 'count' ? '攻擊次數' : '財務損失 (百萬美元)',
                        titlefont: { family: 'Microsoft JhengHei, Arial' }
                    }
                },
                text: data.values.map(v => currentIndustryChart === 'count' ?
                    v.toLocaleString() : `$${v.toFixed(1)}M`),
                textposition: 'auto',
                hovertemplate: `<b>%{y}</b><br>${currentIndustryChart === 'count' ? '攻擊次數' : '財務損失'}: %{x${currentIndustryChart === 'count' ? ':,' : ':.1f'}}<extra></extra>`
            };

            const layout = {
                title: {
                    text: `產業類型${currentIndustryChart === 'count' ? '攻擊次數' : '財務損失'}分析`,
                    font: { family: 'Microsoft JhengHei, Arial', size: 16 },
                    x: 0.5  // 居中標題
                },
                xaxis: {
                    title: {
                        text: currentIndustryChart === 'count' ? '攻擊次數' : '財務損失 (百萬美元)',
                        font: { family: 'Microsoft JhengHei, Arial', size: 14 }
                    },
                    tickfont: { size: 12 }
                },
                yaxis: {
                    title: {
                        text: '產業類型',
                        font: { family: 'Microsoft JhengHei, Arial', size: 14 },
                        standoff: 25  // 增加距離
                    },
                    font: { family: 'Microsoft JhengHei, Arial' },
                    categoryorder: 'total ascending',
                    tickfont: {
                        size: 11,  // 稍微縮小字體
                        family: 'Microsoft JhengHei, Arial'
                    },
                    automargin: true  // 自動調整邊距
                },
                height: 500,
                font: { family: 'Microsoft JhengHei, Arial', size: 12 },
                hovermode: 'closest',
                margin: {
                    l: 200,  // 進一步增加左邊距
                    r: 80,
                    t: 100,
                    b: 60
                },
                showlegend: false
            };

            Plotly.newPlot('industry-chart', [trace], layout, { responsive: true, displayModeBar: true });
        } catch (error) {
            console.error('Error loading industry chart:', error);
            chartDiv.classList.remove('loading');
            chartDiv.innerHTML =
                '<div class="alert alert-danger">載入圖表失敗</div>';
        }
    }

    // Load Attack Types chart using Plotly.js
    async function loadAttackTypes() {
        const chartDiv = document.getElementById('attack-types-chart');
        try {
            const response = await fetch('/api/attack_types');
            const data = await response.json();
            chartDiv.classList.remove('loading');
            chartDiv.innerHTML = '';

            // Create pie chart
            const trace = {
                type: 'pie',
                labels: data.labels,
                values: data.values,
                hole: 0.3,
                marker: {
                    colors: [
                        '#8dd3c7', '#ffffb3', '#bebada', '#fb8072', '#80b1d3',
                        '#fdb462', '#b3de69', '#fccde5', '#d9d9d9', '#bc80bd'
                    ]
                },
                textinfo: 'label+percent',
                textposition: 'auto',
                hovertemplate: '<b>%{label}</b><br>數量: %{value}<br>佔比: %{percent}<extra></extra>'
            };

            const layout = {
                title: {
                    text: '不同攻擊類型佔比分析',
                    font: { family: 'Microsoft JhengHei, Arial', size: 16 }
                },
                height: 500,
                font: { family: 'Microsoft JhengHei, Arial', size: 12 }
            };

            Plotly.newPlot('attack-types-chart', [trace], layout, { responsive: true, displayModeBar: true });
        } catch (error) {
            console.error('Error loading attack types:', error);
            chartDiv.classList.remove('loading');
            chartDiv.innerHTML =
                '<div class="alert alert-danger">載入圖表失敗</div>';
        }
    }

    // Load Defense Resolution Box Plot using Plotly.js
    async function loadDefenseResolution() {
        const chartDiv = document.getElementById('defense-resolution-chart');
        try {
            const response = await fetch('/api/defense_resolution');
            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            chartDiv.classList.remove('loading');
            chartDiv.innerHTML = '';

            // 準備盒鬚圖數據
            const traces = [];
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];

            data.defense_methods.forEach((method, index) => {
                if (data.resolution_data[method] && data.resolution_data[method].length > 0) {
                    traces.push({
                        type: 'box',
                        y: data.resolution_data[method],
                        name: method,
                        boxpoints: 'outliers',
                        marker: {
                            color: colors[index % colors.length],
                            outliercolor: 'rgba(219, 64, 82, 0.6)',
                            line: {
                                outliercolor: 'rgba(219, 64, 82, 0.6)',
                                outlierwidth: 2
                            }
                        },
                        line: {
                            color: colors[index % colors.length]
                        }
                    });
                }
            });

            const layout = {
                title: {
                    text: '防禦方法與事件解決時間比較',
                    font: { family: 'Microsoft JhengHei, Arial', size: 16 }
                },
                xaxis: {
                    title: {
                        text: '防禦方法',
                        font: { family: 'Microsoft JhengHei, Arial', size: 14 }
                    },
                    tickangle: -45,
                    automargin: true
                },
                yaxis: {
                    title: {
                        text: '事件解決時間 (小時)',
                        font: { family: 'Microsoft JhengHei, Arial', size: 14 }
                    }
                },
                height: 500,
                font: { family: 'Microsoft JhengHei, Arial', size: 12 },
                hovermode: 'closest',
                margin: {
                    l: 80,
                    r: 50,
                    t: 100,
                    b: 120
                }
            };

            Plotly.newPlot('defense-resolution-chart', traces, layout, {
                responsive: true,
                displayModeBar: true
            });

            // 更新統計表格
            updateDefenseStatsTable(data.statistics);

        } catch (error) {
            console.error('Error loading defense resolution chart:', error);
            chartDiv.classList.remove('loading');
            chartDiv.innerHTML =
                '<div class="alert alert-danger">載入圖表失敗: ' + error.message + '</div>';
        }
    }

    // 更新統計表格
    function updateDefenseStatsTable(statistics) {
        const tbody = document.querySelector('#defense-stats-table tbody');
        tbody.innerHTML = '';

        Object.keys(statistics).forEach(method => {
            const stats = statistics[method];
            const row = tbody.insertRow();

            row.innerHTML = `
                <td><strong>${method}</strong></td>
                <td>${stats.count}</td>
                <td>${stats.mean.toFixed(1)}h</td>
                <td>${stats.median.toFixed(1)}h</td>
                <td>${stats.std.toFixed(1)}h</td>
                <td>${stats.min.toFixed(1)}h</td>
                <td>${stats.max.toFixed(1)}h</td>
            `;
        });
    }

    // Initialize all charts
    document.addEventListener('DOMContentLoaded', function () {
        loadIndustryChart();
        loadAttackTypes();
        loadDefenseResolution(); // 替換原本的 loadTimeSeries()
    });
</script>
{% endblock %}