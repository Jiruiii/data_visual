{% extends "base.html" %} {% block content %}
<div class="container">
  <div class="content-container">
    <div class="page-header">
      <h1><i class="fas fa-project-diagram"></i> é€²éšè¦–è¦ºåŒ–åˆ†æ</h1>
      <p>ä½¿ç”¨ Sankey åœ–å’Œ Treemap é€²è¡Œæ·±åº¦è³‡æ–™æ¢ç´¢</p>
    </div>

    <!-- Sankey Diagram -->
    <div class="chart-container">
      <h3 class="chart-title">
        <i class="fas fa-stream"></i> Sankey åœ–ï¼šæ”»æ“Šæµå‘è¦–è¦ºåŒ–
      </h3>
      <div class="alert alert-primary">
        <h6><i class="fas fa-info-circle"></i> ä»€éº¼æ˜¯ Sankey åœ–ï¼Ÿ</h6>
        <p>
          Sankey
          åœ–æ˜¯ä¸€ç¨®<strong>æµç¨‹åœ–</strong>ï¼Œé€éä¸åŒå¯¬åº¦çš„æµå‹•å¸¶ä¾†è¡¨ç¤ºæ•¸é‡çš„å¤§å°ã€‚
          éå¸¸é©åˆå±•ç¾<strong>å¤šå±¤ç´šé—œè¯é—œä¿‚</strong>å’Œ<strong>æµå‘åˆ†å¸ƒ</strong>ã€‚
        </p>
        <p class="mb-0">
          <strong>æœ¬åœ–å‘ˆç¾ï¼š</strong>åœ‹å®¶ â†’ æ”»æ“Šé¡å‹ â†’ ç›®æ¨™ç”¢æ¥­
          ä¸‰å€‹å±¤ç´šçš„æµå‘é—œä¿‚ï¼Œ
          è®“æˆ‘å€‘æ¸…æ¥šçœ‹åˆ°ã€Œå“ªäº›åœ‹å®¶ç™¼ç”Ÿå“ªäº›æ”»æ“Šæ‰‹æ³•ä¸¦å½±éŸ¿å“ªäº›ç”¢æ¥­ã€ã€‚
        </p>
      </div>
      <div id="sankey-chart" class="loading">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <div class="mt-4">
        <h6><i class="fas fa-eye"></i> å¾ Sankey åœ–å¯ä»¥è§€å¯Ÿåˆ°ï¼š</h6>
        <ul>
          <li>
            <strong>æ”»æ“Šè·¯å¾‘è¿½è¹¤ï¼š</strong>
            å¯ä»¥æ¸…æ¥šçœ‹å‡ºç‰¹å®šåœ‹å®¶ç™¼ç”Ÿå“ªç¨®æ”»æ“Šé¡å‹ï¼Œä»¥åŠé€™äº›æ”»æ“Šä¸»è¦å½±éŸ¿å“ªäº›ç”¢æ¥­
          </li>
          <li>
            <strong>é—œè¯æ€§åˆ†æï¼š</strong>
            ä¾‹å¦‚ï¼šæŸåœ‹å®¶çš„å‹’ç´¢è»Ÿé«”æ”»æ“Šä¸»è¦å½±éŸ¿é‡‘èæ¥­ï¼Œé¡¯ç¤ºé‡å°æ€§æ”»æ“Šçš„ç‰¹å¾µ
          </li>
          <li>
            <strong>è³‡æºåˆ†é…ï¼š</strong>
            æµå‘çš„å¯¬åº¦ä»£è¡¨æ”»æ“Šæ¬¡æ•¸ï¼Œå¯¬åº¦è¶Šå¤§è¡¨ç¤ºè©²è·¯å¾‘çš„æ”»æ“Šè¶Šé »ç¹ï¼Œéœ€è¦å„ªå…ˆé˜²ç¦¦
          </li>
          <li>
            <strong>å¤šç¶­åº¦æ´å¯Ÿï¼š</strong>
            å–®ä¸€åœ–è¡¨åŒæ™‚å±•ç¾ä¸‰å€‹ç¶­åº¦ï¼ˆä¾†æºã€æ‰‹æ³•ã€ç›®æ¨™ï¼‰ï¼Œæ¯”åˆ†é–‹çœ‹ä¸‰å¼µåœ–æ›´æœ‰æ•´é«”æ„Ÿ
          </li>
        </ul>

        <div class="alert alert-success mt-3">
          <h6><i class="fas fa-lightbulb"></i> ç‚ºä»€éº¼é¸æ“‡ Sankey åœ–ï¼Ÿ</h6>
          <p class="mb-0">
            ç›¸æ¯”å‚³çµ±çš„è¡¨æ ¼æˆ–å †ç–Šåœ–ï¼ŒSankey
            åœ–çš„<strong>è¦–è¦ºæ•ˆæœå’Œæ•…äº‹æ€§éƒ½è¶…ç´šå¼·</strong>ï¼
            å®ƒä¸åªå±•ç¤ºè³‡æ–™ï¼Œæ›´å±•ç¤ºè³‡æ–™ä¹‹é–“çš„<strong>æµå‹•å’Œé—œè¯</strong>ã€‚
            åœ¨ç¶²è·¯å®‰å…¨é ˜åŸŸï¼Œç†è§£ã€Œå“ªäº›åœ‹å®¶ç™¼ç”Ÿä»€éº¼æ”»æ“Šã€å½±éŸ¿å“ªäº›ç”¢æ¥­ã€çš„å®Œæ•´è·¯å¾‘è‡³é—œé‡è¦ã€‚
          </p>
        </div>
      </div>
    </div>

    <!-- Treemap -->
    <div class="chart-container">
      <h3 class="chart-title">
        <i class="fas fa-th"></i> Treemapï¼šç›®æ¨™ç”¢æ¥­èˆ‡æ”»æ“Šé¡å‹åˆ†å¸ƒ
      </h3>
      <div class="alert alert-primary">
        <h6><i class="fas fa-info-circle"></i> ä»€éº¼æ˜¯ Treemap (æ¨¹ç‹€åœ–)ï¼Ÿ</h6>
        <p>
          Treemap
          ä½¿ç”¨<strong>å·¢ç‹€çŸ©å½¢</strong>ä¾†å±•ç¤ºå±¤ç´šè³‡æ–™ï¼ŒçŸ©å½¢çš„å¤§å°ä»£è¡¨æ•¸å€¼çš„å¤§å°ã€‚
          éå¸¸é©åˆå±•ç¾<strong>éƒ¨åˆ†èˆ‡æ•´é«”çš„é—œä¿‚</strong>å’Œ<strong>éšå±¤çµæ§‹</strong>ã€‚
        </p>
        <p class="mb-0">
          <strong>æœ¬åœ–å‘ˆç¾ï¼š</strong
          >æ¯å€‹ç”¢æ¥­é­å—çš„æ”»æ“Šæ¬¡æ•¸ï¼Œä»¥åŠè©²ç”¢æ¥­ä¸‹ä¸åŒæ”»æ“Šé¡å‹çš„åˆ†å¸ƒã€‚ å¤§çŸ©å½¢ =
          è©²ç”¢æ¥­è¢«æ”»æ“Šæ¬¡æ•¸å¤šï¼Œå…§éƒ¨å°çŸ©å½¢ = ä¸åŒæ”»æ“Šé¡å‹çš„ä½”æ¯”ã€‚
        </p>
      </div>
      <div id="treemap-chart" class="loading">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <div class="mt-4">
        <h6><i class="fas fa-eye"></i> å¾ Treemap å¯ä»¥è§€å¯Ÿåˆ°ï¼š</h6>
        <ul>
          <li>
            <strong>é«˜é¢¨éšªç”¢æ¥­ï¼š</strong>
            é¢ç©æœ€å¤§çš„çŸ©å½¢ä»£è¡¨è¢«æ”»æ“Šæœ€å¤šçš„ç”¢æ¥­ï¼Œä¾‹å¦‚ï¼š
            <ul>
              <li>é‡‘èæ¥­ - é«˜åƒ¹å€¼ç›®æ¨™ï¼Œå¸¸é­å—å‹’ç´¢è»Ÿé«”æ”»æ“Š</li>
              <li>é†«ç™‚æ¥­ - æ•æ„Ÿè³‡æ–™å¤šï¼Œæ˜¯è³‡æ–™å¤–æ´©çš„ä¸»è¦ç›®æ¨™</li>
              <li>æ”¿åºœéƒ¨é–€ - é—œéµåŸºç¤è¨­æ–½ï¼Œæ˜¯ APT æ”»æ“Šé‡é»</li>
              <li>ç§‘æŠ€ç”¢æ¥­ - æŠ€è¡“æ©Ÿå¯†çš„ä¸»è¦ç›®æ¨™</li>
            </ul>
          </li>
          <li>
            <strong>æ”»æ“Šé¡å‹åˆ†å¸ƒï¼š</strong>
            é»é€²æ¯å€‹ç”¢æ¥­å¯çœ‹åˆ°ä¸åŒé¡è‰²çš„å­å€å¡Šï¼Œä»£è¡¨é‡å°è©²ç”¢æ¥­çš„ä¸åŒæ”»æ“Šé¡å‹
          </li>
          <li>
            <strong>ç©ºé–“åˆ©ç”¨ï¼š</strong>
            ç›¸æ¯”é•·æ¢åœ–æˆ–è¡¨æ ¼ï¼ŒTreemap èƒ½åœ¨æœ‰é™ç©ºé–“å…§å±•ç¤ºæ›´å¤šå±¤ç´šçš„è³‡è¨Š
          </li>
          <li>
            <strong>è¦–è¦ºå°æ¯”ï¼š</strong>
            çŸ©å½¢å¤§å°çš„å°æ¯”éå¸¸ç›´è§€ï¼Œä¸€çœ¼å°±èƒ½çœ‹å‡ºå“ªäº›åŸ è™Ÿéœ€è¦é‡é»é˜²è­·
          </li>
        </ul>

        <div class="alert alert-success mt-3">
          <h6><i class="fas fa-lightbulb"></i> ç‚ºä»€éº¼é¸æ“‡ Treemapï¼Ÿ</h6>
          <p class="mb-0">
            Treemap æœ€å¤§çš„å„ªå‹¢æ˜¯<strong>ä¸€åœ–å¤šè¨Š</strong>ï¼ˆOne view, multiple
            insightsï¼‰ï¼ å®ƒåŒæ™‚å±•ç¤ºï¼š(1) å“ªå€‹åŸ è™Ÿè¢«æ”»æ“Šæœ€å¤š (2)
            è©²åŸ è™Ÿé­å—å“ªäº›é¡å‹æ”»æ“Š (3) å„æ”»æ“Šé¡å‹çš„ä½”æ¯”ã€‚
            è€Œä¸”è¦–è¦ºæ•ˆæœè¶…ç´šå¸ç›ï¼Œå¾ˆé©åˆåœ¨ç°¡å ±ä¸­ä½¿ç”¨ï¼Œè®“è§€çœ¾å¿«é€ŸæŠ“ä½é‡é»ã€‚
          </p>
        </div>
      </div>
    </div>

    <!-- Comparison: Basic vs Advanced Charts -->
    <div class="mt-4">
      <h3><i class="fas fa-balance-scale"></i> åŸºæœ¬åœ–è¡¨ vs é€²éšåœ–è¡¨</h3>
      <div class="row">
        <div class="col-md-6 mb-3">
          <div class="card border-0 shadow h-100">
            <div class="card-body">
              <h5 class="card-title text-center">
                <i
                  class="fas fa-chart-bar"
                  style="color: var(--primary-color)"
                ></i>
                åŸºæœ¬åœ–è¡¨
              </h5>
              <ul>
                <li><strong>å„ªé»ï¼š</strong>ç›´è§€æ˜“æ‡‚ã€è£½ä½œç°¡å–®ã€é€šç”¨æ€§é«˜</li>
                <li><strong>é©ç”¨ï¼š</strong>å–®ä¸€ç¶­åº¦æˆ–ç°¡å–®æ¯”è¼ƒ</li>
                <li>
                  <strong>ä¾‹å¦‚ï¼š</strong
                  >é•·æ¢åœ–æ¯”è¼ƒæ•¸å€¼ã€åœ“é¤…åœ–é¡¯ç¤ºä½”æ¯”ã€æŠ˜ç·šåœ–å‘ˆç¾è¶¨å‹¢
                </li>
                <li><strong>é™åˆ¶ï¼š</strong>é›£ä»¥åŒæ™‚å±•ç¾å¤šå€‹ç¶­åº¦çš„é—œè¯</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <div
            class="card border-0 shadow h-100"
            style="border-left: 5px solid var(--accent-color) !important"
          >
            <div class="card-body">
              <h5 class="card-title text-center">
                <i
                  class="fas fa-project-diagram"
                  style="color: var(--accent-color)"
                ></i>
                é€²éšåœ–è¡¨
              </h5>
              <ul>
                <li>
                  <strong>å„ªé»ï¼š</strong>å¤šç¶­åº¦é—œè¯ã€å±¤ç´šçµæ§‹æ¸…æ™°ã€è¦–è¦ºè¡æ“ŠåŠ›å¼·
                </li>
                <li><strong>é©ç”¨ï¼š</strong>è¤‡é›œé—œä¿‚ã€æµç¨‹è¿½è¹¤ã€éšå±¤åˆ†æ</li>
                <li>
                  <strong>ä¾‹å¦‚ï¼š</strong>Sankey åœ–è¿½è¹¤æµå‘ã€Treemap å±•ç¾å±¤ç´š
                </li>
                <li><strong>ç‰¹è‰²ï¼š</strong>æä¾›æ›´æ·±å±¤çš„è³‡æ–™æ´å¯Ÿå’Œæ•…äº‹æ€§</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Insights Summary -->
    <div
      class="card border-0 shadow mt-4"
      style="
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
      "
    >
      <div class="card-body">
        <h4><i class="fas fa-star"></i> é€²éšè¦–è¦ºåŒ–çš„åƒ¹å€¼</h4>
        <p class="lead">
          Sankey åœ–å’Œ Treemap
          ä¸åªæ˜¯ã€Œæ¼‚äº®çš„åœ–è¡¨ã€ï¼Œå®ƒå€‘èƒ½æ­éœ²åŸºæœ¬åœ–è¡¨çœ‹ä¸åˆ°çš„<strong>æ·±å±¤æ¨¡å¼</strong>ï¼š
        </p>
        <div class="row mt-3">
          <div class="col-md-6">
            <h6>ğŸ’¡ Sankey åœ–æ­éœ²</h6>
            <ul>
              <li>æ”»æ“Šè€…çš„ä½œæˆ°æ¨¡å¼</li>
              <li>ä¾†æº-æ‰‹æ³•-ç›®æ¨™çš„å®Œæ•´éˆæ¢</li>
              <li>è³‡æºé›†ä¸­çš„é—œéµè·¯å¾‘</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6>ğŸ’¡ Treemap æ­éœ²</h6>
            <ul>
              <li>é˜²ç¦¦è³‡æºçš„å„ªå…ˆé †åº</li>
              <li>åŸ è™Ÿèˆ‡æ”»æ“Šé¡å‹çš„ç›¸é—œæ€§</li>
              <li>æ•´é«”å¨è„…çš„çµæ§‹åˆ†å¸ƒ</li>
            </ul>
          </div>
        </div>
        <p class="mt-3 mb-0">
          <i class="fas fa-quote-left"></i>
          <em>
            è³‡æ–™è¦–è¦ºåŒ–çš„æœ€çµ‚ç›®çš„ä¸æ˜¯ã€Œç•«åœ–ã€ï¼Œè€Œæ˜¯ã€Œè¬›æ•…äº‹ã€å’Œã€Œç™¼ç¾æ´å¯Ÿã€ã€‚
            é€²éšåœ–è¡¨è®“æˆ‘å€‘èƒ½å¤ ç”¨æ›´æœ‰èªªæœåŠ›çš„æ–¹å¼ï¼Œå‚³é”è¤‡é›œçš„è³‡æ–™é—œä¿‚ã€‚
          </em>
          <i class="fas fa-quote-right"></i>
        </p>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Load Sankey diagram using Plotly.js
  async function loadSankey() {
    const chartDiv = document.getElementById("sankey-chart");
    try {
      const response = await fetch("/api/sankey");
      const data = await response.json();
      chartDiv.classList.remove("loading");
      chartDiv.innerHTML = "";

      // Create Sankey diagram
      const trace = {
        type: "sankey",
        orientation: "h",
        node: {
          pad: 15,
          thickness: 20,
          line: {
            color: "black",
            width: 0.5,
          },
          label: data.nodes,
          color: data.node_colors,
          hovertemplate:
            "<b>%{label}</b><br>ç¸½æ”»æ“Šæ¬¡æ•¸: %{value}<extra></extra>",
        },
        link: {
          source: data.sources,
          target: data.targets,
          value: data.values,
          color: "rgba(0,0,0,0.2)",
          hovertemplate:
            "<b>%{source.label} â†’ %{target.label}</b><br>æ”»æ“Šæ¬¡æ•¸: %{value}<extra></extra>",
        },
      };

      const layout = {
        title: {
          text: "æ”»æ“Šæµå‘ï¼šåœ‹å®¶ â†’ æ”»æ“Šé¡å‹ â†’ ç›®æ¨™ç”¢æ¥­",
          font: { family: "Microsoft JhengHei, Arial", size: 16 },
        },
        font: {
          family: "Microsoft JhengHei, Arial",
          size: 12,
        },
        height: 700,
      };

      Plotly.newPlot("sankey-chart", [trace], layout, {
        responsive: true,
        displayModeBar: true,
      });
    } catch (error) {
      console.error("Error loading Sankey diagram:", error);
      chartDiv.classList.remove("loading");
      chartDiv.innerHTML =
        '<div class="alert alert-danger">è¼‰å…¥ Sankey åœ–å¤±æ•—ï¼š' +
        error.message +
        "</div>";
    }
  }

  // Load Treemap using Plotly.js
  async function loadTreemap() {
    const chartDiv = document.getElementById("treemap-chart");
    try {
      const response = await fetch("/api/treemap");
      const data = await response.json();

      if (data.error) {
        throw new Error(data.error);
      }

      // é©—è­‰è³‡æ–™
    //   console.log("Treemap data:", {
    //     labels: data.labels.length,
    //     parents: data.parents.length,
    //     values: data.values.length,
    //     sample: {
    //       labels: data.labels.slice(0, 5),
    //       parents: data.parents.slice(0, 5),
    //       values: data.values.slice(0, 5),
    //     },
    //   });
      console.log(data)

      // æª¢æŸ¥æ˜¯å¦æœ‰ NaN å€¼
      const hasNaN = data.values.some(
        (v) => v === null || v === undefined || isNaN(v)
      );
      if (hasNaN) {
        throw new Error("è³‡æ–™ä¸­åŒ…å«ç„¡æ•ˆæ•¸å€¼");
      }

      chartDiv.classList.remove("loading");
      chartDiv.innerHTML = "";

      // Color scale mapping
      const colorScales = {
        default: "RdYlGn",
        viridis: "Viridis",
        plasma: "Plasma",
        inferno: "Inferno",
      };

      // Create Treemap
      const trace = {
        type: "treemap",
        labels: data.labels,
        parents: data.parents,
        values: data.values,
        textposition: "middle center",
        marker: {
          colors: data.values,
          colorscale: colorScales[data.colorscheme],
          cmid: Math.max(...data.values) / 2,
          colorbar: {
            title: "äº‹ä»¶æ•¸",
            thickness: 20,
            len: 0.7,
          },
          line: {
            width: 2,
            color: "white",
          },
        },
        textinfo: "label+value+percent parent",
        textfont: {
          family: "Microsoft JhengHei, Arial",
          size: 12,
        },
        hovertemplate:
          "<b>%{label}</b><br>äº‹ä»¶æ•¸: %{value:,.0f}<br>ä½”æ¯”: %{percentParent}<extra></extra>",
      };

      const layout = {
        title: {
          text: "ç›®æ¨™ç”¢æ¥­èˆ‡æ”»æ“Šé¡å‹åˆ†å¸ƒï¼ˆæ¨¹ç‹€åœ–ï¼‰",
          font: { family: "Microsoft JhengHei, Arial", size: 16 },
        },
        font: {
          family: "Microsoft JhengHei, Arial",
          size: 11,
        },
        height: 600,
        margin: { t: 50, l: 25, r: 25, b: 25 },
      };

      Plotly.newPlot("treemap-chart", [trace], layout, {
        responsive: true,
        displayModeBar: true,
      });
    } catch (error) {
      console.error("Error loading Treemap:", error);
      chartDiv.classList.remove("loading");
      chartDiv.innerHTML =
        '<div class="alert alert-danger">è¼‰å…¥ Treemap å¤±æ•—ï¼š' +
        error.message +
        "</div>";
    }
  }

  // Initialize all charts
  document.addEventListener("DOMContentLoaded", function () {
    loadSankey();
    loadTreemap();
  });
</script>
{% endblock %}
